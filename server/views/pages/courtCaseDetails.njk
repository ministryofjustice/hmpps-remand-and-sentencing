{% extends "../partials/backLinkLayout.njk" %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "hmpps/components/court-cases-release-dates/offence-card/macro.njk" import offenceCard %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{%- from "govuk/components/tag/macro.njk" import govukTag -%}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}

{% set pageTitle = applicationName + " - Court case details" %}

{% block content %}
{% if successMessage %}

{% set html %}
  <h3 class="govuk-notification-banner__heading" data-qa="notification-banner-heading">
    This hearing has been deleted.
  </h3>
  <p class="govuk-body" data-qa="notification-banner-content">{{successMessage}}</p>
{% endset %}

  {{ govukNotificationBanner({
    html: html,
    type: "success"
  }) }}
{% endif %}

    {{ super() }}
    <div class="govuk-grid-row">

        <div class="govuk-grid-column-full">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
              <h1 class="govuk-heading-l govuk-!-margin-top-4">
                  {% if courtCaseDetails.hearings | length == 0 %}
                      Hearings
                  {% else %}
                      Hearings{{ ' for ' + courtCaseDetails.latestCaseReference if courtCaseDetails.latestCaseReference }} at {{ courtMap[courtCaseDetails.latestCourtCode] if courtMap[courtCaseDetails.latestCourtCode] else courtCaseDetails.latestCourtCode }}
                  {% endif %}
              </h1>
            </div>
          </div>

          {% if courtCaseDetails.mergedToInsetText %}
              {{ govukInsetText({
                  text: courtCaseDetails.mergedToInsetText,
                  attributes: {
                      "data-qa": "mergedToInsetText"
                  }
              }) }}
          {% endif %}

          <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

          {% if courtCaseDetails.hearings | length == 0 %}
              <p>There are no saved hearings.</p>
          {% endif %}

          <div data-qa="hearings-section">
            {% for hearing in courtCaseDetails.hearings %}
                {% if loop.index != 1 %}
                    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
                {% endif %}
                <div data-qa="hearing">
                    {{ hearingCard(hearing, courtCaseDetails) }}
                </div>
            {% endfor %}
          </div>

        </div>
    </div>
{% endblock %}

{% macro hearingCard(hearing, courtCaseDetails) %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
            <h2 class="govuk-heading-m">
              {{ hearing.courtCaseReference + ' at ' if hearing.courtCaseReference }}
              {{ courtMap[hearing.courtCode] if courtMap[hearing.courtCode] else hearing.courtCode }}
              on {{ hearing.appearanceDate | formatDate }}
            </h2>
        </div>

        <div class="govuk-grid-column-one-quarter">
            <ul class="offence-card-actions-list" data-qa="hearingActionList-{{hearing.appearanceUuid}}">
                {% if not hearing.hasAnyRecalls and not viewOnlyEnabled %}
                    <li class="offence-card-action-link">
                        <a class="govuk-link--no-visited-state"
                           href="{% if hearing.warrantType == 'NON_SENTENCING' %}
                                      /person/{{ nomsId }}/edit-court-case/{{ courtCaseDetails.courtCaseUuid }}/edit-court-appearance/{{ hearing.appearanceUuid }}/non-sentencing/load-hearing-details
                                  {% else %}
                                      /person/{{ nomsId }}/edit-court-case/{{ courtCaseDetails.courtCaseUuid }}/edit-court-appearance/{{ hearing.appearanceUuid }}/sentencing/load-hearing-details
                                  {% endif %}">
                            Edit
                        </a>
                    </li>
                    {% if hearing.canDelete %}
                      <li class="offence-card-action-link">
                        <a href="/person/{{ nomsId }}/edit-court-case/{{ courtCaseDetails.courtCaseUuid }}/{{ hearing.appearanceUuid }}/confirm-delete"
                           class="govuk-link--no-visited-state">Delete</a>
                      </li>
                    {% endif %}
                {% endif %}
            </ul>
        </div>
    </div>

    <div class="govuk-!-margin-bottom-6">
    {% if hearing.source == 'NOMIS' %}
      {{ govukTag({
        text: "From NOMIS"
      }) }}
    {% endif %}
    </div>

    {% if hearing.mergedFromCases and hearing.mergedFromCases | length > 0 %}
      {{ govukInsetText({
        html: hearing.mergedFromCases | join('<br>'),
        classes: "govuk-!-margin-0",
        attributes: { "data-qa": "mergedFromText" }
      }) }}
    {% endif %}

    {% if not hearing.canDelete %}
      {{ govukInsetText({
        text: "You cannot delete a hearing that includes sentences.",
        classes: "govuk-!-margin-0"
      }) }}
    {% endif %}




    <div class="govuk-grid-row govuk-!-padding-bottom-2 govuk-!-margin-top-2">
        <div class="govuk-grid-column-one-third">
            <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Case reference</h3>
            <p data-qa="case-reference" class="govuk-body govuk-!-margin-bottom-3">
              {{ hearing.courtCaseReference if hearing.courtCaseReference else 'Not entered' }}
            </p>

            <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Hearing date</h3>
            <p data-qa="hearing-date" class="govuk-body govuk-!-margin-bottom-3">
              {{ hearing.appearanceDate | formatDate }}
            </p>

            {% if hearing.warrantType == 'SENTENCING' and hearing.overallConvictionDate %}
                <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Conviction date</h3>
                <p data-qa="conviction-date" class="govuk-body govuk-!-margin-bottom-2">
                  {{ hearing.overallConvictionDate | formatDate }}
                </p>
            {% endif %}
        </div>

        <div class="govuk-grid-column-one-third">
            <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Location</h3>
            <p class="govuk-body govuk-!-margin-bottom-2" data-qa="location">
              {{ courtMap[hearing.courtCode] if courtMap[hearing.courtCode] else hearing.courtCode }}
            </p>

            <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Outcome</h3>
            <p class="govuk-body govuk-!-margin-bottom-3" data-qa="outcome">
              {{ hearing.outcome | appearanceOutcomeOrLegacy(hearing.legacyData) }}
            </p>
        </div>

        <div class="govuk-grid-one-third">
            {% if hearing.warrantType == 'NON_SENTENCING' %}
                <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Next appearance</h3>
                <p class="govuk-body govuk-!-margin-bottom-2" data-qa="next-appearance">
                  {{ hearing.nextCourtAppearance | formatNextHearing(courtMap) }}
                </p>
            {% endif %}
            <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Court documents</h3>
            <ul class="govuk-list govuk-list--no--bullet govuk-!-margin-bottom-3" data-qa="court-documents">
                {% if hearing.documentsWithUiType | length == 0 %}
                    No documents uploaded
                {% else %}
                    {% for document in hearing.documentsWithUiType %}
                      <span style="vertical-align: middle;">
                        <svg class="moj-timeline__document-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 20" width="20" height="16">
                          <path d="M9 7V1.5L14.5 7H9zM2 0C.9 0 0 .9 0 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6l-6-6H2z"></path>
                        </svg>
                        <a class="govuk-link govuk-link--no-visited-state"
                           target="_blank"
                           href="/person/{{ nomsId }}/{{ addOrEditCourtCase }}/{{ courtCaseReference }}/edit-court-appearance/{{ hearing.appearanceUuid }}/{{ document.documentUUID }}/download-document">
                          <strong>{{ document.documentType }}</strong>
                        </a>
                      </span>
                      <br>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>

        <div class="govuk-grid-column-full govuk-!-margin-top-4">
            <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Offences</h3>
            {% set offenceDetailsHtml %}
              {% for charge in hearing.charges %}
                  {{ offenceCard({
                      offenceCode: charge.offenceCode,
                      offenceName: offenceMap[charge.offenceCode],
                      offenceStartDate: charge.offenceStartDate | formatDate if charge.offenceStartDate else 'Not entered',
                      offenceEndDate: charge.offenceEndDate | formatDate,
                      outcome: charge.outcome | chargeOutcomeOrLegacy(charge.legacyData),
                      countNumber: charge.sentence.chargeNumber,
                      lineNumber: charge.sentence.legacyData.nomisLineReference if charge.sentence and charge.sentence.legacyData,
                      convictionDate: charge.sentence.convictionDate | formatDate,
                      terrorRelated: charge.terrorRelated,
                      isSentenced: charge.sentence,
                      periodLengths: charge.sentence.periodLengths | periodLengthsToSentenceLengths,
                      sentenceServeType: charge.sentence.sentenceServeType,
                      consecutiveTo: consecutiveToSentenceDetailsMap[charge.sentence.consecutiveToSentenceUuid],
                      sentenceType: charge.sentence.sentenceType.description | sentenceTypeValueOrLegacy(charge.sentence.legacyData),
                      fineAmount: charge.sentence.fineAmount.fineAmount,
                      detailsClasses: 'govuk-!-padding-4',
                      mergedFromCase: charge.mergedFromCase,
                      courtDetails: courtMap
                  }) }}
              {% endfor %}
            {% endset %}
            {{ govukDetails({
                summaryText: 'offences (' + hearing.charges | length  + ')',
                html: offenceDetailsHtml,
                classes: "filter white show-toggle govuk-!-margin-bottom-0",
                attributes: { "data-qa": "offences" }
            }) }}
        </div>
    </div>
{% endmacro %}
